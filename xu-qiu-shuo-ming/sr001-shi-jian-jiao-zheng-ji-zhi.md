---
description: 時間校正機制
---

# 時間校正機制



### 需求說明

因為通常有網路的情況下NTP取得時間應該都沒問題，就不再考量增加can bus校時的方式，簡化處理邏輯，而can bus校時就用在，離線模式＋二代屏的情境就好\
\
避免時間錯誤，唯一解法就是時間正確校正前，不顯示時間，避免顯示錯誤時間\
目前校正的幾個做法：

* OS原生NTP校正：LCD上電時會做一次初始校正，但當沒有網路時，錯過了初始校正，會根據OS設定的頻率定時去校正
* Can bus時間校正：透過獲取車機傳上去can bus的時間來校正
* APP主動NTP校正：APP可主動NTP校正時間

***

### 處理邏輯

1\. 預設不顯示時間，完成校時程序完成後才顯示時間。

2\. 開啟APP後，判斷連線模式or離線模式，一代屏or二代屏

* 若為離線模式，且為一代屏，不顯示時間
* 若為離線模式，且為二代屏，
  * 若為寶儷明版，執行\[can bus校時程序]，校時成功則顯示時間，校時失敗則不顯示時間
  * 若為其他版本，不顯示時間
* 若為連線模式，不分一二代屏**，執行**\[APP主動NTP校時程序]，直到校時成功則顯示時間

3\. log紀錄需要能辨識是上述哪一個情境，及最後有沒有顯示時間

**\[can bus校時程序]**：開啟APP後，can持續一直listen，直到抓到時間，判斷can抓到的時間\
\>若與我們目前的系統時間為同一日，就不更新(代表網路校時過了，或時間已經是正確的)，校時成功\
\>若否，則更新系統時間，校時成功\
\>若30分鐘若沒有收到can時間，校時失敗\
結束listen

**\[APP主動NTP校時程序]**：開啟APP後，每分鐘查詢NTP server時間，直到抓到時間，判斷NTP抓到的時間\
\>若與我們目前的系統時間為同一日，就不更新，校時成功\
\>若否，則更新系統時間，校時成功

NTP採用車屏後台NTP service: [ebus.foxconn.com](http://ebus.foxconn.com)
